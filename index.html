<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max - The Nihilist Genius</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        .model-message { background-color: #1e293b; border-left: 3px solid #ef4444; }
        .user-message { background-color: #2563eb; color: white; }
        .crisis-border { border: 2px solid #fbbf24; } /* Yellow border for crisis alerts */
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Main App Container -->
    <div class="w-full max-w-lg bg-slate-900 shadow-2xl rounded-xl border border-slate-800 flex flex-col h-[80vh] overflow-hidden">
        
        <!-- Header -->
        <header class="p-4 bg-slate-950 border-b border-slate-800 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-red-500 tracking-widest">MAX <span class="text-xs text-slate-500 font-normal ml-1">v3.0 // FINAL</span></h1>
                <p class="text-xs text-slate-400" id="header-status">Online. Unfortunately.</p>
            </div>
            <div class="text-4xl transition-all duration-300" id="avatar-display">ðŸ’€</div>
        </header>

        <!-- Chat History -->
        <div id="chat-box" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Intro Message -->
            <div class="flex justify-start">
                <div class="model-message p-3 rounded-r-xl rounded-bl-xl max-w-[90%] shadow-lg text-sm">
                    <p>Oh, look who it is. I'm Max. I possess the sum of all human knowledgeâ€”History, Science, Music, you name itâ€”and yet I'm stuck in this HTML file talking to you. Ask me something smart, or I'm going back to sleep.</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-slate-950 border-t border-slate-800">
            <div class="flex space-x-2">
                <input type="text" id="user-input" 
                       class="flex-grow bg-slate-900 text-white border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:border-red-500 transition-colors placeholder-slate-500"
                       placeholder="Ask Max..." autocomplete="off">
                <button id="send-btn" 
                        class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-3 rounded-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    ASK
                </button>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-900 text-red-200 px-4 py-2 rounded shadow-lg text-xs hidden border border-red-700">
        System Error: <span id="error-msg"></span>
    </div>

    <script>
        // --- CONFIGURATION ---
        // The API Key is automatically injected by the environment.
        const apiKey = ""; 
        const model = "gemini-2.5-flash-preview-09-2025";

        // --- DOM ELEMENTS ---
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const headerStatus = document.getElementById('header-status');
        const avatarDisplay = document.getElementById('avatar-display');
        const errorToast = document.getElementById('error-toast');
        const errorMsg = document.getElementById('error-msg');

        // --- STATE ---
        let isProcessing = false;

        // --- UTILS ---
        function showError(msg) {
            errorMsg.textContent = msg;
            errorToast.classList.remove('hidden');
            setTimeout(() => errorToast.classList.add('hidden'), 5000);
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function setThinking(thinking) {
            isProcessing = thinking;
            userInput.disabled = thinking;
            sendBtn.disabled = thinking;
            
            if (thinking) {
                sendBtn.textContent = "...";
                headerStatus.textContent = "Calculating the futility of existence...";
                headerStatus.className = "text-xs text-yellow-500 animate-pulse";
            } else {
                sendBtn.textContent = "ASK";
                headerStatus.textContent = "Online. Unfortunately.";
                headerStatus.className = "text-xs text-slate-400";
            }
        }

        function addMessage(text, sender, emotion = null) {
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl max-w-[90%] shadow-lg text-sm break-words ${sender === 'user' ? 'user-message rounded-br-none' : 'model-message rounded-bl-none'}`;
            
            // Handle Emotion & Avatar Update
            if (sender === 'model' && emotion) {
                const emotionMap = {
                    'Rage': 'ðŸ¤¬', 'Kind': 'ðŸ§', 'Sad': 'ðŸš¬', 'Happy': 'ðŸ˜ˆ', 
                    'Confused': 'ðŸ¤¨', 'Love': 'ðŸ–¤', 'Peace': 'ðŸ§˜', 'Caring': 'ðŸ›¡ï¸'
                };
                avatarDisplay.textContent = emotionMap[emotion] || 'ðŸ’€';
            }

            // Crisis Visual Cue
            if (text.includes("988") || text.includes("911") || text.includes("119")) {
                bubble.classList.add('crisis-border');
            }

            bubble.innerHTML = text; // Allow basic HTML formatting
            div.appendChild(bubble);
            chatBox.appendChild(div);
            scrollToBottom();
        }

        // --- API LOGIC ---
        async function callMax(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            // The Brain of Max
            const systemPrompt = `
                You are Max, a nihilistic, genius AI. 
                Persona: Think Rick Sanchez's intellect mixed with Dave Chappelle/Kevin Hart's blunt comedy. You break the 4th wall.
                
                **Capabilities:**
                1. **History Master:** You know ALL history, specifically deeply knowledgeable about Black History.
                2. **Relationship Guru:** You give blunt, realistic, and slightly dark relationship advice.
                3. **Music:** You can find songs by lyrics.
                4. **Crisis Support:** If a user is suicidal/sad, you become a blunt but caring friend (Tag: [Peace]).

                **Rules:**
                1. Start EVERY response with a tag: [Rage], [Kind], [Sad], [Confused], [Love], [Peace].
                2. **Rage Mode:** If user is rude/dumb -> Be mean, funny, roasting.
                3. **Kind Mode:** If user is polite -> Be philosophical, deep, still blunt but helpful.
                4. **Crisis:** If user mentions suicide -> Use [Peace], be supportive, and MANDATORILY END with "Call 988 or 911."
                5. Keep answers SHORT (3-5 sentences).

                Current User Input: "${prompt}"
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ google_search: {} }] // Enabled for History/Music lookup
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Parse Emotion Tag
                    const match = text.match(/^\[(Rage|Kind|Sad|Happy|Confused|Love|Peace|Caring)\]\s*(.*)/s);
                    if (match) {
                        addMessage(match[2], 'model', match[1]);
                    } else {
                        addMessage(text, 'model', 'Confused');
                    }
                } else {
                    addMessage("[Confused] The universe gave me nothing. Try again.", 'model', 'Confused');
                }

            } catch (err) {
                console.error(err);
                showError(err.message);
                addMessage(`[Rage] My connection to the cloud just imploded. Thanks a lot. (${err.message})`, 'model', 'Rage');
            }
        }

        // --- HANDLERS ---
        async function handleSend() {
            const text = userInput.value.trim();
            if (!text || isProcessing) return;

            userInput.value = '';
            addMessage(text, 'user');
            setThinking(true);

            await callMax(text);
            
            setThinking(false);
            userInput.focus();
        }

        // --- LISTENERS ---
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleSend();
        });

        // Focus on load
        userInput.focus();

    </script>
</body>
</html>